<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>The Cosmos Audio Infrastructure (CAI) </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="The Cosmos Audio Infrastructure (CAI) ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="../toc">
    
    
    <meta property="docfx:newtab" content="true">
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../index.html" title="Home">Home</a>
                      </li>
                      <li>
                          <a href="../../articles/Installation/UserKit.html" title="Install">Install</a>
                      </li>
                      <li>
                          <a href="https://gocosmos.org" title="Cosmos Website">Cosmos Website</a>
                      </li>
                      <li>
                          <a href="../../articles/GettingStarted.html" title="Articles">Articles</a>
                      </li>
                      <li>
                          <a href="../../api/cosmos/Cosmos.Core.html" title="Cosmos">Cosmos</a>
                      </li>
                      <li>
                          <a href="../../api/xsharp/XSharp.html" title="X#">X#</a>
                      </li>
                      <li>
                          <a href="../../api/il2cpu/Cosmos.IL2CPU.html" title="IL2CPU">IL2CPU</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="../GettingStarted.html" title="Getting Started" class="">Getting Started</a>
                    </li>
                    <li class="">
                      <a href="../Compiler/il2cpu.html" title="Compiler" class="">Compiler</a>
                    </li>
                    <li class="">
                      <a href="../Changelog.html" title="Change Log" class="">Change Log</a>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Debugger</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Debugger/DebugCommands.html" title="Debug Commands" class="">Debug Commands</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Installation</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Installation/UserKit.html" title="User Kit" class="">User Kit</a>
                          </li>
                          <li class="">
                            <a href="../Installation/DevKit.html" title="Dev Kit" class="">Dev Kit</a>
                          </li>
                          <li class="">
                            <a href="../Installation/Running.html" title="Running" class="">Running</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Kernel</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Kernel/Levels.html" title="Levels" class="">Levels</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Plugs.html" title="Plugs" class="">Plugs</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Startup.html" title="Startup" class="">Startup</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/OnBoot.html" title="OnBoot" class="">OnBoot</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/CGS.html" title="Graphics" class="">Graphics</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/VFS.html" title="Virtual File System" class="">Virtual File System</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Network.html" title="Network" class="">Network</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/ManifestResouceStream.html" title="Resource Files" class="">Resource Files</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/MemoryManagement.html" title="Memory Management and Garbage Collection" class="">Memory Management and Garbage Collection</a>
                          </li>
                          <li class="active">
                            <a href="../Kernel/Audio.html" title="Audio" class="active">Audio</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Reference</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Reference/x86.html" title="x86" class="">x86</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Tests</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Tests/TestRunner.html" title="Test Runner" class="">Test Runner</a>
                          </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="the-cosmos-audio-infrastructure-cai">The Cosmos Audio Infrastructure (CAI)</h1>

<p>The Cosmos Audio Infrastructure allows for audio manipulation/conversion, audio I/O, and communication between audio devices. The CAI was designed with simplicity and versatility in mind.</p>
<p>A basic example of playing audio through an AC97-compatible audio card:</p>
<pre><code class="lang-cs">var mixer = new AudioMixer();
var audioStream = MemoryAudioStream.FromWave(sampleAudioBytes);
var driver = AC97.Initialize(bufferSize: 4096);
mixer.Streams.Add(audioStream);

var audioManager = new AudioManager()
{
    Stream = mixer,
    Output = driver
};
audioManager.Enable();
</code></pre>
<p>The sampleAudioBytes are the bytes of a .WAV audio file. You can read it from <a href="https://cosmosos.github.io/articles/Kernel/VFS.html">VFS</a> or using <a href="https://cosmosos.github.io/articles/Kernel/ManifestResouceStream.html">ManifestResourceStream</a>.</p>
<h2 id="audio-streams">Audio Streams</h2>
<p>An <code>AudioStream</code> is an object that can provide sample data to audio buffers. By design, the base <code>AudioStream</code> class does not have any length or position properties, as audio streams may be infinite - for example, an output stream from a microphone, or an audio mixer. All seekable streams inherit from the class <code>SeekableAudioStream</code>, which provides functionality for accessing the position/length properties and allows methods to determine whether they accept infinite and finite streams, or only finite streams.</p>
<h3 id="reading-audio-streams-from-memory">Reading audio streams from memory</h3>
<p>You can create seekable audio streams from byte arrays using the <code>MemoryAudioStream</code> class:</p>
<pre><code class="lang-cs">byte[] bytes = GetArrayOfAudioSamplesFromSomewhere();
var memAudioStream = new MemoryAudioStream(new SampleFormat(AudioBitDepth.Bits16, 2, true), 48000, bytes);
</code></pre>
<p>However, usually, you will have an audio file which contains a header containing information about the format of the audio samples it contains. The MemoryAudioStream class features support for the <a href="https://en.wikipedia.org/wiki/WAV">Waveform Audio File Format (WAVE)</a>, commonly used with the .WAV extension. To create an memory audio stream from a .WAV file, simply do:</p>
<pre><code class="lang-cs">byte[] bytes = GetWavFileFromSomewhere();
var wavAudioStream = MemoryAudioStream.FromWave(bytes); 
</code></pre>
<p>The method will parse the file and return a <code>MemoryAudioStream</code>. The sample format will be determined by using the .WAV header. Please keep in mind that this method only accepts uncompressed LPCM samples, which is the most common encoding used in .WAV files.</p>
<h2 id="audio-mixing">Audio Mixing</h2>
<p>The CAI includes an <code>AudioMixer</code> class out of the box. This class is an infinite <code>AudioStream</code> that mixes given streams together. Please keep in mind that mixing several audio streams together can result in <a href="https://en.wikipedia.org/wiki/Clipping_(signal_processing)">signal clipping</a>. In order to prevent clipping, it's recommended to either decrease the volume of the processed streams by using the <code>GainPostProcessor</code>, or implementing your own <a href="https://en.wikipedia.org/wiki/Limiter">audio limiter</a>.</p>
<h2 id="audio-buffers">Audio Buffers</h2>
<p>Audio buffers are commonly used in both hardware and software handling - for this reason, the <code>AudioBuffer</code> class exists to operate over an array of raw audio sample data.</p>
<h3 id="audio-buffer-rw">Audio Buffer R/W</h3>
<p>Audio buffers can be easily written to or read from with the help of the <code>AudioBufferWriter</code> or <code>AudioBufferReader</code> classes, respectively. These classes automatically perform all bit-depth, channel, and sign conversions. Please keep in mind that conversion operations may be taxing on the CPU. It is recommended to use standard signed 16-bit PCM samples, but, if a conversion operation is necessary, it's recommended to perform them offline (as in, before feeding the unconverted streams into an audio mixer). The reason behind this is because processing the samples within a continously running audio driver will introduce audio crackle if the CPU cannot keep up with the conversion task.</p>
<h2 id="audio-post-processing">Audio Post-Processing</h2>
<p>Audio streams can be processed before they write to an audio buffer by using the <code>PostProcessors</code> property on an <code>AudioStream</code> instance. Post-processing effects are simple to implement:</p>
<pre><code class="lang-cs">public class SilencePostProcessor : AudioPostProcessor {
    public override void Process(AudioBuffer buffer){
        Array.Clear(buffer.RawData);
    }
}
</code></pre>
<p>The above example implements an audio post-processor that turns any audio stream into silence. A more complex example can be seen in the <code>GainPostProcessor</code> class, included with the CAI.</p>
<h2 id="interfacing-with-hardware">Interfacing with hardware</h2>
<p>All hardware interfacing is abstracted behind the <code>AudioDriver</code> class. It's recommended to operate an audio driver using the <code>AudioManager</code> class. Implementations of the <code>AudioDriver</code> class usually do not have a public constructor, as they can handle only one instance of an audio card - if that is the case, they should feature a static <code>Initialize</code> method and a static <code>Instance</code> property.</p>
<p>For example, to initialize the AC97 driver:</p>
<pre><code class="lang-cs">var driver = AC97.Initialize(4096);
</code></pre>
<p>As you can see in the example above, the AC97 initialization method accepts an integer parameter - this is the buffer size the AC97 will use. A higher buffer size will result in a decreased amount of clicks and will usually decrease mixing overhead, however, it will increase latency. Some drivers, like the AC97 driver, include support for changing the buffer size while it is running - however, support for this is not guaranteed.</p>
<p>After initializing a driver, it's recommended to handle it using <code>AudioManager</code>:</p>
<pre><code class="lang-cs">var audioManager = new AudioManager()
{
    Stream = mixer,
    Output = driver
};

audioManager.Enable();
</code></pre>
<p>The audio manager accepts a <code>Stream</code> and an <code>Output</code> property - the <code>Stream</code> is the audio stream that the audio manager will read samples from, which will in turn be provided to the underlying <code>Output</code> audio driver. The audio manager abstracts all hardware handling - however, if you need more control over the devices, you can use the driver classes directly.</p>
<blockquote>
<p><strong>Note</strong><br></p>
</blockquote>
<ul>
<li>
<blockquote>
<p>When interfacing with audio devices, remember not to overload the system when supplying the audio samples. When mixing several streams of audio of different formats, for example, the system can get too overloaded, and this will result in audio crackle, or the system won't be able to respond to the audio device in time, resulting in the audio device stopping all output unexpectedly.</p>
</blockquote>
</li>
</ul>
<p><em>Last updated on 28 July 2023.</em></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/CosmosOS/Cosmos/blob/master/Docs/articles/Kernel/Audio.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <div class="toggle-mode">
                <div class="icon">
                  <i aria-hidden="true">☀</i>
                </div>
                <label class="switch">
                  <input type="checkbox" id="switch-style">
                  <span class="slider round"></span>
                </label>
                <div class="icon">
                  <i aria-hidden="true">☾</i>
                </div>
              </div>
          
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <h5>In This Article</h5>
              <div></div>
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <div class="pull-left">
              <span></span>
              
            </div>
            <div class="toggle-mode pull-right visible-sm visible-xs">
              <div class="icon">
                <i aria-hidden="true">☀</i>
              </div>
              <label class="switch">
                <input type="checkbox" id="switch-style-m">
                <span class="slider round"></span>
              </label>
              <div class="icon">
                <i aria-hidden="true">☾</i>
              </div>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="../../styles/toggle-theme.js"></script>
      </footer>    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
