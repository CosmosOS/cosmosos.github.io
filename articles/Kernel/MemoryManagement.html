<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Memory Management in Cosmos </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Memory Management in Cosmos ">
    <meta name="generator" content="docfx 2.56.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="../toc">
    
    
    <meta property="docfx:newtab" content="true">
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../index.html" title="Home">Home</a>
                      </li>
                      <li>
                          <a href="../../install.html" title="Install">Install</a>
                      </li>
                      <li>
                          <a href="https://gocosmos.org" title="Cosmos Website">Cosmos Website</a>
                      </li>
                      <li>
                          <a href="../../articles/GettingStarted.html" title="Articles">Articles</a>
                      </li>
                      <li>
                          <a>API Documentation</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="../GettingStarted.html" title="Getting Started" class="">Getting Started</a>
                    </li>
                    <li class="">
                      <a href="../Compiler/il2cpu.html" title="Compiler" class="">Compiler</a>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Debugger</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Debugger/DebugCommands.html" title="Debug Commands" class="">Debug Commands</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <a href="../Express/Compile.html" title="Express" class="">Express</a>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Installation</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Installation/DevKit.html" title="Dev Kit" class="">Dev Kit</a>
                          </li>
                          <li class="">
                            <a href="../Installation/Running.html" title="Running" class="">Running</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Kernel</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Kernel/Levels.html" title="Levels" class="">Levels</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Plugs.html" title="Plugs" class="">Plugs</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Startup.html" title="Startup" class="">Startup</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/CGS.html" title="Graphics" class="">Graphics</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/VFS.html" title="Virtual File System" class="">Virtual File System</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Network.html" title="Network" class="">Network</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/ManifestResouceStream.html" title="Resource Files" class="">Resource Files</a>
                          </li>
                          <li class="active">
                            <a href="../Kernel/MemoryManagement.html" title="Memory Management and Garbage Collection" class="active">Memory Management and Garbage Collection</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Reference</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Reference/x86.html" title="x86" class="">x86</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Tests</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Tests/TestRunner.html" title="Test Runner" class="">Test Runner</a>
                          </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="memory-management-in-cosmos">Memory Management in Cosmos</h1>

<p>Cosmos provides dynamic memory allocation on a heap and a garbage collector to free unused objects.</p>
<p>The heap is initialised automatically when the kernel starts and the memory managed is split into pages of 4096 bytes each.</p>
<p>This article provides an overview of how both Memory Allocation and the Garbage Collector can be used (Usage Section) and how they work internally (Internals Section).</p>
<h2 id="memory-allocation">Memory Allocation</h2>
<h3 id="usage">Usage</h3>
<h4 id="allocation">Allocation</h4>
<p>Usually users should be allocating memory indirectly by using <code>new</code> or other standard methods provided by .Net to allocate new objects. In the cases, where you want to allocate a managed block of memory, which is not part of a certain .Net type, a <code>ManagedMemoryBlock</code> or <code>byte[]</code> should suffice. If this is not sufficient, one can use <code>uint GCImplementation.AllocNewObject(uint aSize)</code> to allocate a region of <code>aSize</code> bytes. The returned uint contains the memory address and can be converted to pointer if required.</p>
<p>One can manually free an object using <code>Heap.Free(void* aPtr)</code> or <code>GCImplementation.Free(object aObj)</code>. It is recommended to not manually free .Net objects unless you know what you are doing since Cosmos does not always recognise when it is accessing already freed memory and this can lead to very weird bugs.</p>
<h4 id="information">Information</h4>
<p>Cosmos provides a few methods to get information about the heap status:</p>
<ul>
<li><code>GCImplementation.GetAvailableRAM()</code> returns the size of the memory in MB available to the heap</li>
<li><code>GCImplementation.GetUsedRAM()</code> provides a rough estimate of how many bytes are currently in use</li>
<li><code>HeapSmall.GetAllocatedObjectCount()</code> returns the number of .Net objects currently allocated</li>
<li><code>RAT.GetPageCount(byte aType)</code> returns how many pages of a certain type are allocated. The different type definitions are stored in <code>RAT.PageType</code></li>
</ul>
<h3 id="internals">Internals</h3>
<p>The Heap is managed using the RAT (RAM Allocation Table). The RAT consists of a byte array which for every page in the heap stores its status. The table is stored at the end of the heap starting at <code>mRAT</code> and does not grow during runtime. Pages can be of the following types, <code>Empty</code>, <code>HeapSmall</code>, <code>HeapMedium</code>, <code>HeapLarge</code>, <code>RAT</code>, <code>SMT</code> and <code>Extension</code>. If the value for a type is odd, it means that the page is managed by the GC and objects stored there will be scanned and if possible freed.</p>
<p>The RAT initialisation is triggered using <code>GCImplementation.Init()</code> which is called in the boot sequence defined in CosmosAssembler.cs. If the MemoryMap is available, the largest continuous region of memory is used for the heap.</p>
<p>The RAT is managed through the <code>RAT</code> class. Pages are allocated via <code>void* RAT.AllocPages(byte aType, uint aPageCount = 1)</code>. If more than 1 page is allocated at once, the first page will be marked as type <code>aType</code>, while all later pages are marked as <code>Extension</code>. Pages can be freed (set to type <code>Empty</code>) using <code>void RAT.Free(uint aPageIdx)</code> which also frees any extension pages which follow the first page. To convert between a pointer and the page index, the method <code>uint RAT.GetFirstRATIndex(void* aPtr)</code> can be used.</p>
<p>The Heap itself is managed by the <code>Heap</code> class. It contains the mechanism to allocate (<code>byte* Heap.Alloc(uint aSize)</code>) and free (<code>void Heap.Free(void* aPtr)</code>) objects of various sizes. Objects are seperated by size in bytes into Small (Smaller than 1/4 Page), Medium (Smaller than 1 Page) and Large (Larger than 1 Page). Currently Medium and Large objects are managed the same way using the methods in <code>HeapLarge</code> which do little more than allocating/freeing the necessary number of pages. Small objects are managed differently in <code>HeapSmall</code>.</p>
<p>Small Objects are managed using the SMT (Size Map Table), which is initalised using <code>void HeapSmall.InitSMT(uint aMaxItemSize)</code>. The basic idea of the SMT is to allocate objects of similar sizes on the same page. The SMT grows dynamically as required. The SMT is made up of a series of pages, each of which contains a series of <code>RootSMTBlock</code> each of which link to a chain of <code>SMTBlock</code>. The <code>RootSMTBlock</code> can be thought of as column headers and the <code>SMTBlock</code> as the elements stored in the column. The <code>RootSMTBlock</code> are a linked list, each containing the maximum object size stored in its pages, the location of the first <code>SMTBlock</code> for this size, and the location of the next <code>RootSMTBlock</code>. The list is in ascending order of size, so that the smallest large enough <code>RootSMTBlock</code> is found first. A <code>SMTBlock</code> contains a pointer to the actual page where objects are stored, how much space is left on that page, and a pointer to the next <code>SMTBlock</code>. If every <code>SMTBlock</code> for a certain size is full, a new <code>SMTBlock</code> is allocated. The page linked to by the <code>SMTBlock</code> is split into an array of spaces, each large enough to allocate an object of maximum size with header, which can be iterated through via index and fixed size when allocating. Each object allocated on the <code>HeapSmall</code> has a header of 2 <code>ushort</code>, the first one storing the actual size of the object and the second, the GC status of the object.</p>
<h2 id="garbage-collection">Garbage Collection</h2>
<h3 id="interface">Interface</h3>
<p>The garbage collector has to be manually triggerd using the call <code>int Heap.Collect()</code> which returns the number of objects freed.</p>
<h3 id="internals-1">Internals</h3>
<p>The garbage collector uses the tracing approach, which means that during collection a graph of all reachable objects is created and all non-discovered objects are freed. The garbage collector will only check objects on pages which have a type where the <code>GCManaged</code> bit is set. The graph is created by starting from &quot;root&quot; objects which are either stored in static variables or part of the current stack. Each of these objects is &quot;marked&quot; and all objects referenced by this object are recursivly also &quot;marked&quot; and &quot;swept&quot;. This is done using the methods <code>void Heap.MarkAndSweepObject(void* aPtr)</code> for objects and <code>void Heap.SweepTypedObject(uint* obj, uint type)</code> for structures. For this to work each allocated object holds a 1bit flag if the object was discovered during the marking phase and a 7bit value counter for the number of static references it has. The number of static references an object has is updated using <code>void GCImplementation.IncRootCount(ushort* aPtr)</code> and similar methods, which are called from the Stsfld opcode.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/CosmosOS/Cosmos/blob/6510f61ad4b20568c1386c7e386fc9d3d50bafeb/Docs/articles/Kernel/MemoryManagement.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <div class="toggle-mode">
                <div class="icon">
                  <i aria-hidden="true">☀</i>
                </div>
                <label class="switch">
                  <input type="checkbox" id="switch-style">
                  <span class="slider round"></span>
                </label>
                <div class="icon">
                  <i aria-hidden="true">☾</i>
                </div>
              </div>
          
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <h5>In This Article</h5>
              <div></div>
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <div class="pull-left">
              <span></span>
              
            </div>
            <div class="toggle-mode pull-right visible-sm visible-xs">
              <div class="icon">
                <i aria-hidden="true">☀</i>
              </div>
              <label class="switch">
                <input type="checkbox" id="switch-style-m">
                <span class="slider round"></span>
              </label>
              <div class="icon">
                <i aria-hidden="true">☾</i>
              </div>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="../../styles/toggle-theme.js"></script>
      </footer>    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
