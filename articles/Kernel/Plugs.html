<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Plugs </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Plugs ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="../toc">
    
    
    <meta property="docfx:newtab" content="true">
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../index.html" title="Home">Home</a>
                      </li>
                      <li>
                          <a href="../../articles/Installation/UserKit.html" title="Install">Install</a>
                      </li>
                      <li>
                          <a href="https://gocosmos.org" title="Cosmos Website">Cosmos Website</a>
                      </li>
                      <li>
                          <a href="../../articles/GettingStarted.html" title="Articles">Articles</a>
                      </li>
                      <li>
                          <a href="../../api/cosmos/Cosmos.Core.html" title="Cosmos">Cosmos</a>
                      </li>
                      <li>
                          <a href="../../api/xsharp/XSharp.html" title="X#">X#</a>
                      </li>
                      <li>
                          <a href="../../api/il2cpu/Cosmos.IL2CPU.html" title="IL2CPU">IL2CPU</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="../GettingStarted.html" title="Getting Started" class="">Getting Started</a>
                    </li>
                    <li class="">
                      <a href="../Compiler/il2cpu.html" title="Compiler" class="">Compiler</a>
                    </li>
                    <li class="">
                      <a href="../Changelog.html" title="Change Log" class="">Change Log</a>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Debugger</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Debugger/DebugCommands.html" title="Debug Commands" class="">Debug Commands</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Installation</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Installation/UserKit.html" title="User Kit" class="">User Kit</a>
                          </li>
                          <li class="">
                            <a href="../Installation/DevKit.html" title="Dev Kit" class="">Dev Kit</a>
                          </li>
                          <li class="">
                            <a href="../Installation/Running.html" title="Running" class="">Running</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Kernel</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Kernel/Levels.html" title="Levels" class="">Levels</a>
                          </li>
                          <li class="active">
                            <a href="../Kernel/Plugs.html" title="Plugs" class="active">Plugs</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Startup.html" title="Startup" class="">Startup</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/OnBoot.html" title="OnBoot" class="">OnBoot</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/CGS.html" title="Graphics" class="">Graphics</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/VFS.html" title="Virtual File System" class="">Virtual File System</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Network.html" title="Network" class="">Network</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/ManifestResouceStream.html" title="Resource Files" class="">Resource Files</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/MemoryManagement.html" title="Memory Management and Garbage Collection" class="">Memory Management and Garbage Collection</a>
                          </li>
                          <li class="">
                            <a href="../Kernel/Audio.html" title="Audio" class="">Audio</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Reference</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Reference/x86.html" title="x86" class="">x86</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Tests</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../Tests/TestRunner.html" title="Test Runner" class="">Test Runner</a>
                          </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="plugs">Plugs</h1>

<p>Plugs are used to fill &quot;holes&quot; in .NET libraries and replace them with different
code. Holes exist for example when a method in .NET library uses a Windows API
call. That API call will not be available on Cosmos. Emulating the Win32 API would be highly inefficient. Instead,
Cosmos replaces specific methods and property implementations that rely on
Win32 API calls. Plugs can also be used to provide an alternate implementation
for a method, even if it does not rely on the Windows API.</p>
<blockquote>
<p><strong>Important: All plugs must go in a seperate project, which is included in your original project using the <code>PlugsReference</code> attribute in your Kernel's csproj.</strong></p>
</blockquote>
<h2 id="types-of-plugs">Types of plugs</h2>
<p>There are two types of plugs used and supported by Cosmos:</p>
<ul>
<li>Code Plug - A standard C# (or any .NET language) method is used to provide the alternate implementation.</li>
<li>X#/Assembly Languge - In a few cases, it is difficult or impossible to write the code using C#/.Net since one needs exact control over the emitted assembly code. An assembly plug are designed for that case. Cosmos itself only uses this type of plug within the Cosmos.Core projects.</li>
</ul>
<h2 id="how-do-plugs-work">How do plugs work?</h2>
<p>To explain how plugs work, we first need to give an overview of how IL2CPU works. Roughly, IL2CPU compiles a kernel using the following steps:</p>
<ol>
<li>IL2CPU determines a list of all methods and types which are used by the kernel.</li>
<li>It then compiles each of these methods into assembly code.
This is usually done by getting the list of IL instructions which make up the method and translating each of them into some corresponding assembly.</li>
<li>Together with a bit of boilerplate code, the emitted assembly for all the methods is compiled using yasm.</li>
</ol>
<p>Plugs effect what occurs in Step 2; A normal code plug means that rather from taking the IL instructions from the original method, the IL instructions from the plug are used and then converted into assembly. An assembly plug directly states what asm should be emitted.</p>
<h1 id="implementing-a-plug">Implementing a Plug</h1>
<p>While one always plugs individual methods, plugs are defined class-wise. Therefore, the first step to plugging any method is to define a new static class to contain all the pluggged methods for some certain type. This class must be decorated with the <code>Plug</code> attribute. The plug attribute either takes the type it is plugging (<code>Plug(Type target)</code>), or a string with the target name(<code>Plug(string targetName)</code>). Using the string target name is required when plugging internal or private classes. An example for a plugged class is for the <a href="https://github.com/CosmosOS/Cosmos/blob/8a8393353f1957890c5154650e29847fd22bf893/source/Cosmos.System2_Plugs/System/MathImpl.cs#L8-L9">Math class</a>.</p>
<h2 id="code-plug">Code Plug</h2>
<p>Once you have created such a class, you can add methods to the class. If these methods share the signature with a method in the original class they will be used to plug the original methods. For example in the above mentioned Math plug class, the following method plugs the original <code>double Math.Abs(double)</code> implementation. <a href="https://github.com/CosmosOS/Cosmos/blob/8a8393353f1957890c5154650e29847fd22bf893/source/Cosmos.System2_Plugs/System/MathImpl.cs#L52-L63">See here</a>.</p>
<p>Note, when plugging a non-static method, the first argument will be correspond to &quot;this&quot; (the instance for which the method is being called).</p>
<p>Sometimes it is impossible to define a method with exactly the same signature due to some of the arguments being from private or internal classes. In that case you can use the <code>PlugMethod</code> attribute. An example, is the following plug for <code>GC.AllocateNewArray</code> since <code>ALLOC_FLAGS</code> is a private enum. <a href="https://github.com/CosmosOS/Cosmos/blob/8a8393353f1957890c5154650e29847fd22bf893/source/Cosmos.Core_Plugs/System/GCImpl.cs#L17-L29">See here</a>.</p>
<h2 id="assembly-plug">Assembly Plug</h2>
<p>Defining an assembly plug is slightly more complicated. The first step is the same, and one needs to define a method with the same signature as the method one needs to plug. This acts as a plug placeholder. The actual plug implemenation is a new class inheriting from <code>AssemblerMethod</code>. This class needs to override the <code>void AssembleNew(Assembler aAssembler, object aMethodInfo)</code> method. The <code>AssembleNew</code> method will be called when IL2CPU is executing and should emit the required asm. Examples of such classes can be found <a href="https://github.com/CosmosOS/Cosmos/blob/master/source/Cosmos.Core_Plugs/MathImpl.cs">here</a> including the plug implementation for <code>double Math.Round(double)</code> <a href="https://github.com/CosmosOS/Cosmos/blob/8a8393353f1957890c5154650e29847fd22bf893/source/Cosmos.Core_Plugs/MathImpl.cs#L40-L49">here</a>.</p>
<p>The final step is to link the plug implementation to the plug placeholder by adding a <code>PlugMethod(Type Assembler)</code> to the plug placeholder, where the <code>Assembler</code> value is the class you created with the implementation. An example is the plug placeholder for the above mentioned <code>double Math.Round(double)</code>, <a href="https://github.com/CosmosOS/Cosmos/blob/8a8393353f1957890c5154650e29847fd22bf893/source/Cosmos.Core_Plugs/MathImpl.cs#L15-L19">here</a>.</p>
<h2 id="using-plugs-to-write-assembly-in-your-kernel">Using plugs to write Assembly in your Kernel</h2>
<p>While plugs are usually used to overwrite existing methods in the .NET runtime, they can also be used to include assembly methods in your kernel.
This is for example, done to implement the <code>void CPU.UpdateIDT(bool)</code> method in Cosmos. To do this for your own classes and methods is not more difficult than plugging any other method. Simply set target of the plug class to your own class and write the assembly plug as usual. As a reference you can look at <a href="https://github.com/CosmosOS/Cosmos/blob/master/source/Cosmos.Core/CPU.cs">Cosmos.Core/CPU.cs</a>, <a href="https://github.com/CosmosOS/Cosmos/blob/master/source/Cosmos.Core_Asm/CPUImpl.cs">Cosmos.Core_Asm/CPUImpl.cs</a> and <a href="https://github.com/CosmosOS/Cosmos/blob/master/source/Cosmos.Core_Asm/CPU/CPUUpdateIDTAsm.cs">CPUUpdateIDTAsm.cs</a>.</p>
<p><em>Last updated on 28 April 2023.</em></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/CosmosOS/Cosmos/blob/master/Docs/articles/Kernel/Plugs.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <div class="toggle-mode">
                <div class="icon">
                  <i aria-hidden="true">☀</i>
                </div>
                <label class="switch">
                  <input type="checkbox" id="switch-style">
                  <span class="slider round"></span>
                </label>
                <div class="icon">
                  <i aria-hidden="true">☾</i>
                </div>
              </div>
          
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <h5>In This Article</h5>
              <div></div>
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <div class="pull-left">
              <span></span>
              
            </div>
            <div class="toggle-mode pull-right visible-sm visible-xs">
              <div class="icon">
                <i aria-hidden="true">☀</i>
              </div>
              <label class="switch">
                <input type="checkbox" id="switch-style-m">
                <span class="slider round"></span>
              </label>
              <div class="icon">
                <i aria-hidden="true">☾</i>
              </div>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="../../styles/toggle-theme.js"></script>
      </footer>    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
